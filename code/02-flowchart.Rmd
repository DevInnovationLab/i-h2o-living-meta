---
title: "02-flowchart"
output: html_document
---

This file creates a flowchart showing the selection process of studies. It requires that in the same folder, you have a study dataset called study_dataset.xlsx, where each row is 1 study. 

```{r}
# install.packages("readxl")
# install.packages("dplyr")
# install.packages("DiagrammeR")
# install.packages("htmlwidgets")

library(readxl)
library(dplyr)
library(DiagrammeR)
library(htmlwidgets)

# read data
data <- read.csv("../data/Manual systematic review selection - 999_data_set.csv")

# Identified through database searching
counts <- list() # define a list of counts
counts$database <- sum(data$identified.through.database.searching == 1, na.rm = TRUE)

# Studies from other sources (where identified through database searching == 0)
other_sources_data <- data %>%
  filter(identified.through.database.searching == 0 & source != "New addition")

# Unique study sources for added studies
unique_sources <- unique(other_sources_data$source)
sources_text <- paste(unique_sources, collapse = " and ")
counts$other_sources <- nrow(other_sources_data %>% filter(source != "New addition")) + 
                        sum(data$source == "New addition" & data$identified.through.database.searching == 0, na.rm = TRUE)

# Screened
counts$screened <- sum(data$screened == 1, na.rm = TRUE)

# Full text screened for eligibility
counts$full_text <- sum(data$full.text.screened == 1, na.rm = TRUE)

# Relevant intervention
counts$relevant_intervention <- sum(data$relevant.intervention == 1, na.rm = TRUE)

# Low- or middle-income country
counts$lmic <- sum(data$low..or.middle.income.country == 1, na.rm = TRUE)

# RCTs
counts$rct <- sum(data$RCT == 1, na.rm = TRUE)

# Includes children under 5
counts$children_u5 <- sum(data$includes.children.under.5 == 1, na.rm = TRUE)

# Authors contacted
counts$authors_contacted <- sum(data$authors.contacted == 1, na.rm = TRUE)

# Authors responded
counts$authors_responded <- sum(data$authors.responded == 1, na.rm = TRUE)

# Mortality data collected -> this is currently 0 for all
counts$mortality_collected <- sum(data$mortality.data.collected == 1, na.rm = TRUE)

# Mortality data still available -> this is currently 0 for all
counts$mortality_available <- sum(data$mortality.data.still.available == 1, na.rm = TRUE)
```

# Create flow chart
```{r}
flowchart <- grViz("
digraph flowchart {
  
  # Graph settings
  graph [rankdir = TB, fontsize = 12, nodesep = 0.5, ranksep = 0.8]
  node [shape = box, style = filled, fillcolor = lightblue, 
        fontname = Arial, fontsize = 11, margin = 0.2]
  
  # Top row - two boxes side by side
  {rank = same; A1; A2}
  
  # Define nodes
  A1 [label = '@@1']
  A2 [label = '@@2']
  B [label = '@@3']
  C [label = '@@4']
  D [label = '@@5']
  E [label = '@@6']
  F [label = '@@7']
  G [label = '@@8']
  H [label = '@@9']
  I [label = '@@10']
  J [label = '@@11']
  K [label = '@@12']
  
  # Node to merge A1 and A2
  merge [shape = point, width = 0, height = 0]
  
  # Define edges
  A1 -> merge [arrowhead = none]
  A2 -> merge [arrowhead = none]
  merge -> B
  B -> C
  C -> D
  D -> E
  E -> F
  F -> G
  G -> H
  H -> I
  I -> J
  J -> K
}

[1]: paste0('a.1) ', counts$database, ' studies\\nidentified through\\ndatabase searching')
[2]: paste0('a.2) ', counts$other_sources, ' studies from\\n', sources_text)
[3]: paste0('b) ', counts$screened, ' studies screened')
[4]: paste0('c) ', counts$full_text, ' records full-text\\nstudies for eligibility')
[5]: paste0('d) ', counts$relevant_intervention, ' studies with \\n relevant intervention')
[6]: paste0('e) ', counts$lmic, ' studies in low- or\\nmiddle-income country')
[7]: paste0('f) ', counts$rct, ' RCTs')
[8]: paste0('g) ', counts$children_u5, ' studies include\\nchildren under 5')
[9]: paste0('h) ', counts$authors_contacted, ' authors contacted')
[10]: paste0('i) ', counts$authors_responded, ' authors responded')
[11]: paste0('j) ', counts$mortality_collected, ' studies - mortality\\ndata collected')
[12]: paste0('k) ', counts$mortality_available, ' studies - mortality\\ndata still available')
")

saveWidget(flowchart, "../output/selection_flowchart.html", selfcontained = TRUE)
```